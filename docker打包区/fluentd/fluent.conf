<source>
  @type prometheus
  bind 0.0.0.0
  port 24231
  metrics_path /metrics
</source>

<source>
  @type prometheus_output_monitor
  interval 15
  <labels>
    hostname ${hostname}
  </labels>
</source>

<source>
  @type kafka_group
  brokers 10.x.x.x.x:9092
  format json
  topics aaa,bbb,ccc,
  add_prefix kafka
  <parse>
    @type multi_format
    <pattern>
      format_firstline /\d{4}-\d{1,2}-\d{1,2}/
      format1 /^(?<time>\d{4}-\d{1,2}-\d{1,2} \d{1,2}:\d{1,2}:\d{1,2}) \[(?<thread>.*)\] (?<level>[^\s]+)(?<message>.*)/
    </pattern>
  </parse>
</source>

<filter kafka.*>
  @type record_transformer
  remove_keys $.@metadata,$._version,$._score,$.kubernetes.container.image
  # <record>
  #   depname  ${["kubernetes.container.name"]}
  # </record>
</filter>

<match kafka.*>
  @type elasticsearch_dynamic
  user elasticxxx
  password xxxxxxx
  hosts x.x.x.x:9200
  logstash_format true
  logstash_prefix k8s-${record['kubernetes']['container']['name']}
  logstash_dateformat %Y.%m.%d
  <buffer tag, $.kubernetes.container.name>
   @type memory
   timekey 1h
   timekey_wait 3m
   total_limit_size 1024m
   flush_at_shutdown true
   flush_interval 15
   flush_mode interval
   retry_wait 5
   retry_max_times 5
   retry_timeout 1h
  </buffer> 
</match>
